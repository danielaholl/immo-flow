'use client';

import { useEffect, useState, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { useAuthContext } from '@/app/providers/AuthProvider';
import { Header } from '../components/Header';
import { FavoriteButton } from '../components/FavoriteButton';
import { updateUserProfile, getPropertiesByUserId, getUserFavorites, getUserSearchHistory, deleteSearchHistory, generateSearchProfile, type SearchHistory, type SearchProfile } from '@immoflow/api';
import { Property, Favorite } from '@immoflow/database';
import { User, Phone, Mail, MapPin, Building2, Shield, ChevronRight, Rows3, Edit3, LogOut, Home, Plus, Eye, Heart, Camera, Send, ImagePlus, Search, Clock, X, Sparkles, RefreshCw } from 'lucide-react';

type MessageType = 'bot' | 'user';
type InputType = 'quick-reply' | 'text' | 'textarea' | 'phone' | 'image-upload' | 'none';

interface QuickReplyOption {
  label: string;
  value: string;
  icon?: React.ReactNode;
}

interface Message {
  id: string;
  type: MessageType;
  content: string;
  inputType?: InputType;
  options?: QuickReplyOption[];
  placeholder?: string;
  defaultValue?: string;
  field?: string;
}

interface ProfileData {
  first_name: string;
  last_name: string;
  phone: string;
  address: string;
  company: string;
  bio: string;
  avatar_url?: string;
}

// Questions for NEW profiles
const NEW_PROFILE_QUESTIONS: Omit<Message, 'id'>[] = [
  {
    type: 'bot',
    content: 'Willkommen bei Ihrem Profil! üëã Ich helfe Ihnen, Ihr Profil zu vervollst√§ndigen. So k√∂nnen andere Nutzer Sie besser kennenlernen.',
    inputType: 'none',
  },
  {
    type: 'bot',
    content: 'Laden Sie ein Profilbild hoch, damit andere Nutzer Sie erkennen k√∂nnen. (Optional)',
    inputType: 'image-upload',
    field: 'avatar_url',
  },
  {
    type: 'bot',
    content: 'Wie ist Ihr Vorname?',
    inputType: 'text',
    placeholder: 'Vorname eingeben...',
    field: 'first_name',
  },
  {
    type: 'bot',
    content: 'Und Ihr Nachname?',
    inputType: 'text',
    placeholder: 'Nachname eingeben...',
    field: 'last_name',
  },
  {
    type: 'bot',
    content: 'Unter welcher Telefonnummer k√∂nnen Interessenten Sie erreichen?',
    inputType: 'phone',
    placeholder: '+49 123 456789',
    field: 'phone',
  },
  {
    type: 'bot',
    content: 'Wie lautet Ihre Adresse?',
    inputType: 'text',
    placeholder: 'z.B. Musterstra√üe 1, 12345 Berlin',
    field: 'address',
  },
  {
    type: 'bot',
    content: 'F√ºr welche Firma arbeiten Sie? (Optional)',
    inputType: 'text',
    placeholder: 'z.B. Nestela GmbH',
    field: 'company',
  },
  {
    type: 'bot',
    content: 'M√∂chten Sie etwas √ºber sich erz√§hlen? Diese Bio wird auf Ihrem Profil angezeigt. (Optional - Sie k√∂nnen diesen Schritt √ºberspringen)',
    inputType: 'textarea',
    placeholder: 'z.B. "Immobilienexperte mit 10 Jahren Erfahrung in M√ºnchen..."',
    field: 'bio',
  },
];

// Generate questions for EDITING existing profiles
const generateEditQuestions = (profile: any): Omit<Message, 'id'>[] => {
  const currentAvatar = profile?.avatar_url ? 'Aktuelles Profilbild vorhanden' : 'Kein Profilbild';

  return [
    {
      type: 'bot',
      content: `Hallo ${profile?.first_name || 'zur√ºck'}! üëã Lassen Sie uns Ihr Profil bearbeiten. Ich zeige Ihnen die aktuellen Werte - √§ndern Sie einfach was Sie m√∂chten.`,
      inputType: 'none',
    },
    {
      type: 'bot',
      content: `Ihr Profilbild: ${currentAvatar}. M√∂chten Sie ein neues Bild hochladen?`,
      inputType: 'image-upload',
      field: 'avatar_url',
    },
    {
      type: 'bot',
      content: `Ihr aktueller Vorname ist "${profile?.first_name || ''}". √Ñndern oder best√§tigen Sie:`,
      inputType: 'text',
      placeholder: 'Vorname eingeben...',
      field: 'first_name',
    },
    {
      type: 'bot',
      content: `Ihr aktueller Nachname ist "${profile?.last_name || ''}". √Ñndern oder best√§tigen Sie:`,
      inputType: 'text',
      placeholder: 'Nachname eingeben...',
      field: 'last_name',
    },
    {
      type: 'bot',
      content: `Ihre aktuelle Telefonnummer: ${profile?.phone || 'Nicht angegeben'}. √Ñndern oder best√§tigen Sie:`,
      inputType: 'phone',
      placeholder: '+49 123 456789',
      field: 'phone',
    },
    {
      type: 'bot',
      content: `Ihre aktuelle Adresse: ${profile?.address || 'Nicht angegeben'}. √Ñndern oder best√§tigen Sie:`,
      inputType: 'text',
      placeholder: 'z.B. Musterstra√üe 1, 12345 Berlin',
      field: 'address',
    },
    {
      type: 'bot',
      content: `Ihre aktuelle Firma: ${profile?.company || 'Nicht angegeben'}. √Ñndern oder best√§tigen Sie:`,
      inputType: 'text',
      placeholder: 'z.B. Nestela GmbH',
      field: 'company',
    },
    {
      type: 'bot',
      content: `Ihre aktuelle Bio: ${profile?.bio ? `"${profile.bio.substring(0, 50)}${profile.bio.length > 50 ? '...' : ''}"` : 'Keine Bio'}. M√∂chten Sie diese √§ndern?`,
      inputType: 'textarea',
      placeholder: 'z.B. "Immobilienexperte mit 10 Jahren Erfahrung in M√ºnchen..."',
      field: 'bio',
    },
  ];
};

// Check if profile is complete (has required fields)
function isProfileComplete(profile: any): boolean {
  return !!(profile?.first_name && profile?.last_name);
}

export default function ProfilePage() {
  const { user, profile, loading: authLoading, refreshProfile, signOut } = useAuthContext();
  const router = useRouter();

  // View mode: 'overview' for existing profiles, 'edit' for new/editing profiles
  const [viewMode, setViewMode] = useState<'overview' | 'edit'>('overview');
  const [isEditMode, setIsEditMode] = useState(false);

  // Chat state
  const [messages, setMessages] = useState<Message[]>([]);
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [questions, setQuestions] = useState<Omit<Message, 'id'>[]>(NEW_PROFILE_QUESTIONS);
  const [isTyping, setIsTyping] = useState(false);
  const [textInput, setTextInput] = useState('');
  const [profileData, setProfileData] = useState<Partial<ProfileData>>({});
  const [isComplete, setIsComplete] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [saveSuccess, setSaveSuccess] = useState(false);
  const [uploadedAvatar, setUploadedAvatar] = useState<string>('');

  // User properties state
  const [userProperties, setUserProperties] = useState<Property[]>([]);
  const [loadingProperties, setLoadingProperties] = useState(false);

  // User favorites state
  const [userFavorites, setUserFavorites] = useState<(Favorite & { properties: Property })[]>([]);
  const [loadingFavorites, setLoadingFavorites] = useState(false);

  // User search history state
  const [searchHistory, setSearchHistory] = useState<SearchHistory[]>([]);
  const [loadingHistory, setLoadingHistory] = useState(false);

  // Search profile state
  const [searchProfile, setSearchProfile] = useState<SearchProfile | null>(null);
  const [loadingProfile, setLoadingProfile] = useState(false);

  // Refs
  const chatContainerRef = useRef<HTMLDivElement>(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const textInputRef = useRef<HTMLInputElement>(null);
  const textareaRef = useRef<HTMLTextAreaElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // Redirect to login if not authenticated
  useEffect(() => {
    if (!authLoading && !user) {
      router.push('/auth/login?redirectTo=/profile');
    }
  }, [authLoading, user, router]);

  // Determine view mode based on profile completeness
  useEffect(() => {
    if (!authLoading && profile) {
      if (isProfileComplete(profile)) {
        setViewMode('overview');
      } else {
        setViewMode('edit');
      }
    }
  }, [authLoading, profile]);

  // Load user properties
  useEffect(() => {
    const loadUserProperties = async () => {
      if (!user) return;

      setLoadingProperties(true);
      try {
        const properties = await getPropertiesByUserId(user.id);
        setUserProperties(properties);
      } catch (error) {
        console.error('Error loading user properties:', error);
      } finally {
        setLoadingProperties(false);
      }
    };

    if (user && viewMode === 'overview') {
      loadUserProperties();
    }
  }, [user, viewMode]);

  // Load user favorites
  useEffect(() => {
    const loadUserFavorites = async () => {
      if (!user) return;

      setLoadingFavorites(true);
      try {
        const favorites = await getUserFavorites(user.id);
        setUserFavorites(favorites as (Favorite & { properties: Property })[]);
      } catch (error) {
        console.error('Error loading user favorites:', error);
      } finally {
        setLoadingFavorites(false);
      }
    };

    if (user && viewMode === 'overview') {
      loadUserFavorites();
    }
  }, [user, viewMode]);

  // Load user search history
  useEffect(() => {
    const loadSearchHistory = async () => {
      if (!user) return;

      setLoadingHistory(true);
      try {
        const history = await getUserSearchHistory(user.id, 10);
        setSearchHistory(history);
      } catch (error) {
        console.error('Error loading search history:', error);
      } finally {
        setLoadingHistory(false);
      }
    };

    if (user && viewMode === 'overview') {
      loadSearchHistory();
    }
  }, [user, viewMode]);

  // Load existing profile data
  useEffect(() => {
    if (profile) {
      setProfileData({
        first_name: profile.first_name || '',
        last_name: profile.last_name || '',
        phone: profile.phone || '',
        address: profile.address || '',
        company: profile.company || '',
        bio: profile.bio || '',
        avatar_url: profile.avatar_url || '',
      });
      if (profile.avatar_url) {
        setUploadedAvatar(profile.avatar_url);
      }
    }
  }, [profile]);

  // Start conversation when in edit mode (for new profiles only)
  useEffect(() => {
    if (user && viewMode === 'edit' && messages.length === 0 && !isEditMode) {
      setQuestions(NEW_PROFILE_QUESTIONS);
      addBotMessage(0, NEW_PROFILE_QUESTIONS);
    }
  }, [user, viewMode]);

  // Auto-scroll chat to bottom
  useEffect(() => {
    const scrollToBottom = () => {
      if (chatContainerRef.current) {
        const scrollContainer = chatContainerRef.current.querySelector('.overflow-y-auto');
        if (scrollContainer) {
          scrollContainer.scrollTop = scrollContainer.scrollHeight;
        }
      }
    };
    const timer = setTimeout(scrollToBottom, 100);
    return () => clearTimeout(timer);
  }, [messages, isTyping]);

  // Auto-focus input and set default value when new question appears
  useEffect(() => {
    if (isTyping || isComplete || viewMode !== 'edit') return;

    const currentQuestion = messages[messages.length - 1];
    if (!currentQuestion || currentQuestion.type !== 'bot') return;

    const field = currentQuestion.field as keyof ProfileData | undefined;
    if (field && profileData[field]) {
      setTextInput(profileData[field] || '');
    }

    const timer = setTimeout(() => {
      if (currentQuestion.inputType === 'text' || currentQuestion.inputType === 'phone') {
        textInputRef.current?.focus();
        textInputRef.current?.select();
      } else if (currentQuestion.inputType === 'textarea') {
        textareaRef.current?.focus();
        textareaRef.current?.select();
      }
    }, 100);

    return () => clearTimeout(timer);
  }, [messages, isTyping, isComplete, profileData, viewMode]);

  const addBotMessage = async (questionIndex: number, questionList?: Omit<Message, 'id'>[]) => {
    const activeQuestions = questionList || questions;

    if (questionIndex >= activeQuestions.length) {
      setIsComplete(true);
      return;
    }

    setIsTyping(true);
    await new Promise(resolve => setTimeout(resolve, 600 + Math.random() * 300));
    setIsTyping(false);

    const question = activeQuestions[questionIndex];
    const newMessage: Message = {
      id: `bot-${Date.now()}`,
      ...question,
    };

    setMessages(prev => [...prev, newMessage]);
    setCurrentQuestionIndex(questionIndex);

    if (question.inputType === 'none') {
      setTimeout(() => addBotMessage(questionIndex + 1, activeQuestions), 800);
    }
  };

  const addUserMessage = (content: string) => {
    const newMessage: Message = {
      id: `user-${Date.now()}`,
      type: 'user',
      content,
    };
    setMessages(prev => [...prev, newMessage]);
  };

  const handleTextSubmit = (skipEmpty = false) => {
    const currentQuestion = questions[currentQuestionIndex];

    if (!textInput.trim() && !skipEmpty) return;

    if (textInput.trim()) {
      addUserMessage(textInput);
      if (currentQuestion.field) {
        setProfileData(prev => ({ ...prev, [currentQuestion.field!]: textInput }));
      }
    } else {
      addUserMessage('√úbersprungen');
    }

    setTextInput('');
    setTimeout(() => addBotMessage(currentQuestionIndex + 1), 500);
  };

  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      if (event.target?.result) {
        const imageData = event.target.result as string;
        setUploadedAvatar(imageData);
        setProfileData(prev => ({ ...prev, avatar_url: imageData }));
      }
    };
    reader.readAsDataURL(file);
  };

  const handleImageSubmit = () => {
    if (uploadedAvatar) {
      addUserMessage('Profilbild hochgeladen');
    } else {
      addUserMessage('Kein Profilbild');
    }
    setTimeout(() => addBotMessage(currentQuestionIndex + 1), 500);
  };

  const handleSaveProfile = async () => {
    if (!user) {
      console.error('No user found');
      return;
    }

    console.log('Starting profile save...', profileData);
    setIsSubmitting(true);
    setSaveSuccess(false);

    try {
      const updateData = {
        first_name: profileData.first_name || '',
        last_name: profileData.last_name || '',
        phone: profileData.phone || '',
        address: profileData.address || '',
        company: profileData.company || '',
        bio: profileData.bio || '',
        avatar_url: profileData.avatar_url || '',
      };
      console.log('Updating profile with:', updateData);

      await updateUserProfile(user.id, updateData);
      console.log('Profile updated successfully');

      await refreshProfile();
      console.log('Profile refreshed');

      setSaveSuccess(true);

      setTimeout(() => {
        setViewMode('overview');
        setSaveSuccess(false);
      }, 1500);
    } catch (error) {
      console.error('Error updating profile:', error);
      alert(`Fehler beim Speichern des Profils: ${error instanceof Error ? error.message : 'Unbekannter Fehler'}`);
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleSignOut = async () => {
    try {
      await signOut();
      router.push('/');
    } catch (error) {
      console.error('Error signing out:', error);
    }
  };

  const handleStartEdit = () => {
    setMessages([]);
    setCurrentQuestionIndex(0);
    setIsComplete(false);
    setTextInput('');
    setIsEditMode(true);

    const editQuestions = generateEditQuestions(profile);
    setQuestions(editQuestions);
    setViewMode('edit');

    setTimeout(() => addBotMessage(0, editQuestions), 100);
  };

  const handleDeleteSearch = async (id: string) => {
    try {
      await deleteSearchHistory(id);
      setSearchHistory(prev => prev.filter(search => search.id !== id));
    } catch (error) {
      console.error('Error deleting search:', error);
    }
  };

  const handleRepeatSearch = (query: string) => {
    // Navigate to homepage with search query
    router.push(`/?search=${encodeURIComponent(query)}`);
  };

  // Helper function to format relative time
  const formatRelativeTime = (dateString: string): string => {
    const now = new Date();
    const date = new Date(dateString);
    const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

    if (diffInSeconds < 60) {
      return `vor ${diffInSeconds} Sek`;
    } else if (diffInSeconds < 3600) {
      const minutes = Math.floor(diffInSeconds / 60);
      return `vor ${minutes} Min`;
    } else if (diffInSeconds < 86400) {
      const hours = Math.floor(diffInSeconds / 3600);
      return `vor ${hours} Std`;
    } else if (diffInSeconds < 604800) {
      const days = Math.floor(diffInSeconds / 86400);
      return `vor ${days} ${days === 1 ? 'Tag' : 'Tagen'}`;
    } else if (diffInSeconds < 2592000) {
      const weeks = Math.floor(diffInSeconds / 604800);
      return `vor ${weeks} ${weeks === 1 ? 'Woche' : 'Wochen'}`;
    } else if (diffInSeconds < 31536000) {
      const months = Math.floor(diffInSeconds / 2592000);
      return `vor ${months} ${months === 1 ? 'Monat' : 'Monaten'}`;
    } else {
      const years = Math.floor(diffInSeconds / 31536000);
      return `vor ${years} ${years === 1 ? 'Jahr' : 'Jahren'}`;
    }
  };

  const handleGenerateProfile = async () => {
    if (!user) return;

    setLoadingProfile(true);
    try {
      const profile = await generateSearchProfile(user.id);
      setSearchProfile(profile);
    } catch (error) {
      console.error('Error generating search profile:', error);
    } finally {
      setLoadingProfile(false);
    }
  };

  const formatPrice = (price: number) => {
    return new Intl.NumberFormat('de-DE', {
      style: 'currency',
      currency: 'EUR',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(price);
  };

  const getScoreColor = (score: number) => {
    if (score >= 85) return '#22C55E';
    if (score >= 70) return '#F59E0B';
    return '#EF4444';
  };

  const progress = Math.round(((currentQuestionIndex) / (questions.length - 1)) * 100);

  if (authLoading) {
    return (
      <main className="min-h-screen bg-white">
        <Header />
        <div className="flex items-center justify-center h-[calc(100vh-100px)]">
          <p className="text-gray-500">Laden...</p>
        </div>
      </main>
    );
  }

  if (!user) {
    return null;
  }

  const currentQuestion = messages[messages.length - 1];

  // ============================================
  // OVERVIEW VIEW - Two Column Layout
  // ============================================
  if (viewMode === 'overview') {
    return (
      <main className="min-h-screen bg-white">
        <Header />

        <div className="flex flex-col lg:flex-row gap-8 py-8">

            {/* Left Column - Profile Settings */}
            <div className="lg:w-[400px] lg:flex-shrink-0 px-4 lg:pl-8 lg:pr-0">
              {/* Profile Card */}
              <div className="bg-white border border-gray-200 rounded-2xl overflow-hidden mb-6">
                {/* Cover Gradient */}
                <div className="relative bg-gradient-to-br from-primary to-pink-600 h-24">
                </div>

                {/* Avatar & Name */}
                <div className="relative px-6 pb-6">
                  <div className="-mt-12 mb-4">
                    <div className="w-24 h-24 rounded-full bg-white p-1 shadow-lg">
                      {profile?.avatar_url ? (
                        <img
                          src={profile.avatar_url}
                          alt="Profilbild"
                          className="w-full h-full rounded-full object-cover"
                        />
                      ) : (
                        <div className="w-full h-full rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center">
                          <span className="text-3xl font-bold text-gray-400">
                            {profile?.first_name?.charAt(0)?.toUpperCase() || user?.email?.charAt(0)?.toUpperCase() || 'U'}
                          </span>
                        </div>
                      )}
                    </div>
                  </div>

                  <h1 className="font-bold text-gray-900" style={{ fontSize: '26px' }}>
                    {profile?.first_name} {profile?.last_name}
                  </h1>
                  {profile?.company && (
                    <p className="text-gray-500" style={{ fontSize: '16px' }}>{profile.company}</p>
                  )}

                  {profile?.bio && (
                    <p className="text-gray-700 mt-4 leading-relaxed" style={{ fontSize: '16px' }}>
                      {profile.bio}
                    </p>
                  )}
                </div>
              </div>

              {/* Contact Info */}
              <div className="bg-white border border-gray-200 rounded-2xl p-6 mb-6">
                <h2 className="font-semibold text-gray-900 mb-4 flex items-center gap-2" style={{ fontSize: '20px' }}>
                  <Phone size={20} className="text-primary" />
                  Kontaktdaten
                </h2>

                <div className="space-y-4">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                      <Mail size={18} className="text-gray-500" />
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">E-Mail</p>
                      <p className="font-medium text-gray-900" style={{ fontSize: '16px' }}>{user?.email}</p>
                    </div>
                  </div>

                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                      <Phone size={18} className="text-gray-500" />
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Telefon</p>
                      <p className="font-medium text-gray-900" style={{ fontSize: '16px' }}>
                        {profile?.phone || <span className="text-gray-400">Nicht angegeben</span>}
                      </p>
                    </div>
                  </div>

                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                      <MapPin size={18} className="text-gray-500" />
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Adresse</p>
                      <p className="font-medium text-gray-900" style={{ fontSize: '16px' }}>
                        {profile?.address || <span className="text-gray-400">Nicht angegeben</span>}
                      </p>
                    </div>
                  </div>

                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                      <Building2 size={18} className="text-gray-500" />
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Firma</p>
                      <p className="font-medium text-gray-900" style={{ fontSize: '16px' }}>
                        {profile?.company || <span className="text-gray-400">Nicht angegeben</span>}
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Account Settings */}
              <div className="bg-white border border-gray-200 rounded-2xl p-6 mb-6">
                <h2 className="font-semibold text-gray-900 mb-4 flex items-center gap-2" style={{ fontSize: '20px' }}>
                  <User size={20} className="text-gray-600" />
                  Account
                </h2>

                <div className="space-y-3">
                  <div className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                    <div className="flex items-center gap-3">
                      <Mail size={18} className="text-gray-500" />
                      <div>
                        <span className="text-gray-500 text-sm">E-Mail</span>
                        <p className="text-gray-700" style={{ fontSize: '16px' }}>{user?.email}</p>
                      </div>
                    </div>
                  </div>

                  <button
                    onClick={() => alert('Passwort √§ndern wird implementiert')}
                    className="w-full flex items-center justify-between p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors"
                  >
                    <div className="flex items-center gap-3">
                      <Shield size={18} className="text-gray-500" />
                      <span className="text-gray-700" style={{ fontSize: '16px' }}>Passwort √§ndern</span>
                    </div>
                    <ChevronRight size={18} className="text-gray-400" />
                  </button>
                </div>
              </div>

              {/* Action Buttons */}
              <div className="flex gap-3">
                <button
                  onClick={handleStartEdit}
                  className="flex-1 py-3 bg-gray-900 text-white font-medium rounded-xl transition-colors flex items-center justify-center gap-2 hover:bg-gray-800"
                  style={{ fontSize: '16px' }}
                >
                  <Edit3 size={18} />
                  Bearbeiten
                </button>
                <button
                  onClick={handleSignOut}
                  className="flex-1 py-3 text-red-500 font-medium hover:bg-red-50 rounded-xl transition-colors flex items-center justify-center gap-2 border border-gray-200"
                  style={{ fontSize: '16px' }}
                >
                  <LogOut size={18} />
                  Abmelden
                </button>
              </div>
            </div>

            {/* Right Column - Search, Properties & Favorites */}
            <div className="flex-1 px-4 lg:pr-8 lg:pl-0">
              {/* Meine Inserate Section */}
              <div className="mb-8">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="font-semibold text-gray-900 flex items-center gap-2" style={{ fontSize: '20px' }}>
                    <Home size={20} className="text-gray-600" />
                    Meine Inserate ({userProperties.length})
                  </h2>
                  <div className="flex items-center gap-2">
                    {userProperties.length > 0 && (
                      <button
                        onClick={() => router.push('/my-properties')}
                        className="px-3 py-1.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 hover:border-gray-400 font-medium flex items-center gap-1.5 transition-all text-sm"
                      >
                        <Rows3 size={16} />
                        Vergleichen
                      </button>
                    )}
                    <button
                      onClick={() => router.push('/create-listing')}
                      className="px-3 py-1.5 bg-gray-900 text-white rounded-lg hover:bg-gray-800 font-medium flex items-center gap-1.5 transition-all text-sm"
                    >
                      <Plus size={16} />
                      Neu erstellen
                    </button>
                  </div>
                </div>

                {loadingProperties ? (
                  <div className="flex items-center justify-center py-12">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                  </div>
                ) : userProperties.length === 0 ? (
                  <div className="text-center py-10 bg-gray-50 rounded-xl">
                    <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                      <Home size={32} className="text-gray-300" />
                    </div>
                    <p className="text-gray-500 mb-4" style={{ fontSize: '16px' }}>Noch keine Inserate</p>
                    <button
                      onClick={() => router.push('/create-listing')}
                      className="inline-flex items-center gap-2 px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors font-medium text-sm"
                    >
                      <Plus size={16} />
                      Erstes Inserat erstellen
                    </button>
                  </div>
                ) : (
                  <>
                    <div className="flex flex-wrap gap-3">
                      {userProperties.map((property) => (
                        <div
                          key={property.id}
                          onClick={() => router.push(`/property/${property.id}`)}
                          className="group cursor-pointer bg-white border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-all w-[250px]"
                        >
                          <div className="relative aspect-square bg-gray-100">
                            {property.images && property.images.length > 0 ? (
                              <img
                                src={property.images[0]}
                                alt={property.title}
                                className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                              />
                            ) : (
                              <div className="w-full h-full flex items-center justify-center">
                                <Home size={24} className="text-gray-300" />
                              </div>
                            )}
                            <div className={`absolute top-2 left-2 px-2 py-1 rounded-full text-xs font-medium ${
                              property.status === 'active'
                                ? 'bg-green-500 text-white'
                                : property.status === 'pending'
                                ? 'bg-yellow-500 text-white'
                                : 'bg-gray-500 text-white'
                            }`}>
                              {property.status === 'active' ? 'Aktiv' : property.status === 'pending' ? 'Ausstehend' : property.status}
                            </div>
                            <div className="absolute top-2 right-2 flex items-center gap-1 bg-black/60 px-2 py-1 rounded-full">
                              <Eye size={12} className="text-white" />
                              <span className="text-white text-xs font-medium">{property.views || 0}</span>
                            </div>
                          </div>
                          <div className="p-3">
                            <p className="text-primary font-bold text-lg mb-1">{formatPrice(property.price)}</p>
                            <h3 className="font-semibold text-gray-900 text-sm truncate mb-2">{property.title}</h3>
                            <div className="flex items-center gap-1 text-xs text-gray-500 mb-1">
                              <MapPin size={12} className="flex-shrink-0" />
                              <span className="truncate">{property.location}</span>
                            </div>
                            <div className="flex items-center gap-3 text-xs text-gray-600">
                              <span>{property.sqm} m¬≤</span>
                              <span>‚Ä¢</span>
                              <span>{property.rooms} Zi.</span>
                              {property.sqm > 0 && (
                                <>
                                  <span>‚Ä¢</span>
                                  <span>{formatPrice(Math.round(property.price / property.sqm))}/m¬≤</span>
                                </>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </>
                )}
              </div>

              {/* Trennlinie */}
              <hr className="border-gray-200 mb-8" />

              {/* AI Suchprofil Section */}
              <div className="mb-8">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="font-semibold text-gray-900 flex items-center gap-2" style={{ fontSize: '20px' }}>
                    <Sparkles size={20} className="text-yellow-500" />
                    KI Suchprofil
                  </h2>
                  {searchHistory.length > 0 && (
                    <button
                      onClick={handleGenerateProfile}
                      disabled={loadingProfile}
                      className="px-3 py-1.5 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-lg hover:from-yellow-500 hover:to-orange-600 font-medium flex items-center gap-1.5 transition-all text-sm disabled:opacity-50"
                    >
                      {loadingProfile ? (
                        <>
                          <RefreshCw size={16} className="animate-spin" />
                          Generiere...
                        </>
                      ) : (
                        <>
                          <Sparkles size={16} />
                          {searchProfile ? 'Aktualisieren' : 'Generieren'}
                        </>
                      )}
                    </button>
                  )}
                </div>

                {searchHistory.length === 0 ? (
                  <div className="text-center py-10 bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl border border-yellow-200">
                    <div className="w-16 h-16 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-3">
                      <Sparkles size={32} className="text-white" />
                    </div>
                    <p className="text-gray-700 mb-2 font-medium" style={{ fontSize: '16px' }}>
                      Erstelle dein pers√∂nliches Suchprofil
                    </p>
                    <p className="text-gray-600 text-sm mb-4">
                      Suche nach Immobilien, um ein KI-generiertes Profil zu erhalten
                    </p>
                  </div>
                ) : !searchProfile ? (
                  <div className="text-center py-10 bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl border border-yellow-200">
                    <div className="w-16 h-16 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-3">
                      <Sparkles size={32} className="text-white" />
                    </div>
                    <p className="text-gray-700 mb-4" style={{ fontSize: '16px' }}>
                      Lass die KI dein Suchprofil erstellen
                    </p>
                    <button
                      onClick={handleGenerateProfile}
                      disabled={loadingProfile}
                      className="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-lg hover:from-yellow-500 hover:to-orange-600 transition-all font-semibold text-sm shadow-lg hover:shadow-xl disabled:opacity-50"
                    >
                      {loadingProfile ? (
                        <>
                          <RefreshCw size={18} className="animate-spin" />
                          Generiere Profil...
                        </>
                      ) : (
                        <>
                          <Sparkles size={18} />
                          Profil generieren
                        </>
                      )}
                    </button>
                  </div>
                ) : (
                  <div className="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl border border-yellow-200 p-6">
                    {/* Summary */}
                    <div className="mb-6">
                      <h3 className="font-semibold text-gray-900 mb-2 flex items-center gap-2">
                        <Sparkles size={18} className="text-yellow-500" />
                        Zusammenfassung
                      </h3>
                      <p className="text-gray-700 leading-relaxed">{searchProfile.summary}</p>
                    </div>

                    {/* Preferred Locations */}
                    {searchProfile.preferredLocations && searchProfile.preferredLocations.length > 0 && (
                      <div className="mb-6">
                        <h3 className="font-semibold text-gray-900 mb-2 text-sm">Bevorzugte Orte</h3>
                        <div className="flex flex-wrap gap-2">
                          {searchProfile.preferredLocations.map((location, idx) => (
                            <span key={idx} className="px-3 py-1.5 bg-white border border-yellow-300 text-gray-800 rounded-full text-sm">
                              üìç {location}
                            </span>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Price Range */}
                    {searchProfile.priceRange && (
                      <div className="mb-6">
                        <h3 className="font-semibold text-gray-900 mb-2 text-sm">Preisbereich</h3>
                        <p className="text-gray-700">
                          {searchProfile.priceRange.min && `Ab ${searchProfile.priceRange.min.toLocaleString('de-DE')}‚Ç¨`}
                          {searchProfile.priceRange.min && searchProfile.priceRange.max && ' - '}
                          {searchProfile.priceRange.max && `Bis ${searchProfile.priceRange.max.toLocaleString('de-DE')}‚Ç¨`}
                        </p>
                      </div>
                    )}

                    {/* Preferred Rooms */}
                    {searchProfile.preferredRooms && searchProfile.preferredRooms.length > 0 && (
                      <div className="mb-6">
                        <h3 className="font-semibold text-gray-900 mb-2 text-sm">Bevorzugte Zimmeranzahl</h3>
                        <div className="flex flex-wrap gap-2">
                          {searchProfile.preferredRooms.map((rooms, idx) => (
                            <span key={idx} className="px-3 py-1.5 bg-white border border-yellow-300 text-gray-800 rounded-full text-sm">
                              üè† {rooms} Zimmer
                            </span>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Preferred Features */}
                    {searchProfile.preferredFeatures && searchProfile.preferredFeatures.length > 0 && (
                      <div className="mb-6">
                        <h3 className="font-semibold text-gray-900 mb-2 text-sm">Bevorzugte Ausstattung</h3>
                        <div className="flex flex-wrap gap-2">
                          {searchProfile.preferredFeatures.map((feature, idx) => (
                            <span key={idx} className="px-3 py-1.5 bg-white border border-yellow-300 text-gray-800 rounded-full text-sm">
                              ‚ú® {feature}
                            </span>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Recommendations */}
                    {searchProfile.recommendations && searchProfile.recommendations.length > 0 && (
                      <div>
                        <h3 className="font-semibold text-gray-900 mb-3 text-sm">Empfehlungen f√ºr dich</h3>
                        <ul className="space-y-2">
                          {searchProfile.recommendations.map((rec, idx) => (
                            <li key={idx} className="flex items-start gap-2 text-gray-700 text-sm">
                              <span className="text-yellow-500 flex-shrink-0 mt-0.5">‚Üí</span>
                              <span>{rec}</span>
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </div>
                )}
              </div>

              {/* Trennlinie */}
              <hr className="border-gray-200 mb-8" />

              {/* Suchhistorie Section */}
              <div className="mb-8">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="font-semibold text-gray-900 flex items-center gap-2" style={{ fontSize: '20px' }}>
                    <Clock size={20} className="text-gray-600" />
                    Letzte Suchen ({searchHistory.length})
                  </h2>
                </div>

                {loadingHistory ? (
                  <div className="flex items-center justify-center py-12">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                  </div>
                ) : searchHistory.length === 0 ? (
                  <div className="text-center py-10 bg-gray-50 rounded-xl">
                    <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                      <Search size={32} className="text-gray-300" />
                    </div>
                    <p className="text-gray-500 mb-4" style={{ fontSize: '16px' }}>Noch keine Suchen</p>
                    <button
                      onClick={() => router.push('/')}
                      className="inline-flex items-center gap-2 px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors font-medium text-sm"
                    >
                      <Search size={16} />
                      Immobilien suchen
                    </button>
                  </div>
                ) : (
                  <div className="space-y-2">
                    {searchHistory.map((search) => (
                      <div
                        key={search.id}
                        className="group bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all"
                      >
                        <div className="flex items-start justify-between gap-3">
                          <div className="flex-1 min-w-0">
                            <button
                              onClick={() => handleRepeatSearch(search.query)}
                              className="w-full text-left"
                            >
                              <p className="font-medium text-gray-900 mb-1 group-hover:text-primary transition-colors">
                                {search.query}
                              </p>
                              <div className="flex flex-wrap items-center gap-2 text-xs text-gray-500">
                                <span className="flex items-center gap-1">
                                  <Clock size={12} />
                                  {formatRelativeTime(search.last_searched_at)}
                                </span>
                                <span>‚Ä¢</span>
                                <span>{search.results_count} Ergebnis{search.results_count !== 1 ? 'se' : ''}</span>
                                {search.criteria && Object.keys(search.criteria).length > 0 && (
                                  <>
                                    <span>‚Ä¢</span>
                                    <div className="flex flex-wrap gap-1">
                                      {search.criteria.location && (
                                        <span className="px-2 py-0.5 bg-blue-50 text-blue-700 rounded-full text-xs">
                                          {search.criteria.location}
                                        </span>
                                      )}
                                      {search.criteria.rooms && (
                                        <span className="px-2 py-0.5 bg-purple-50 text-purple-700 rounded-full text-xs">
                                          {search.criteria.rooms} Zi.
                                        </span>
                                      )}
                                      {search.criteria.features && search.criteria.features.slice(0, 2).map((feature: string, idx: number) => (
                                        <span key={idx} className="px-2 py-0.5 bg-orange-50 text-orange-700 rounded-full text-xs">
                                          {feature}
                                        </span>
                                      ))}
                                      {search.criteria.features && search.criteria.features.length > 2 && (
                                        <span className="px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full text-xs">
                                          +{search.criteria.features.length - 2}
                                        </span>
                                      )}
                                    </div>
                                  </>
                                )}
                              </div>
                            </button>
                          </div>
                          <button
                            onClick={() => handleDeleteSearch(search.id)}
                            className="flex-shrink-0 p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                            title="Suche l√∂schen"
                          >
                            <X size={16} />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Trennlinie */}
              <hr className="border-gray-200 mb-8" />

              {/* Favoriten Section */}
              <div>
                <div className="flex items-center justify-between mb-4">
                  <h2 className="font-semibold text-gray-900 flex items-center gap-2" style={{ fontSize: '20px' }}>
                    <Heart size={20} className="text-primary" />
                    Favoriten ({userFavorites.length})
                  </h2>
                  <div className="flex items-center gap-2">
                    {userFavorites.length > 0 && (
                      <button
                        onClick={() => router.push('/favorites')}
                        className="px-3 py-1.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 hover:border-gray-400 font-medium flex items-center gap-1.5 transition-all text-sm"
                      >
                        <Rows3 size={16} />
                        Vergleichen
                      </button>
                    )}
                    <button
                      onClick={() => router.push('/')}
                      className="px-3 py-1.5 bg-gray-900 text-white rounded-lg hover:bg-gray-800 font-medium flex items-center gap-1.5 transition-all text-sm"
                    >
                      Entdecken
                    </button>
                  </div>
                </div>

                {loadingFavorites ? (
                  <div className="flex items-center justify-center py-12">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                  </div>
                ) : userFavorites.length === 0 ? (
                  <div className="text-center py-10 bg-gray-50 rounded-xl">
                    <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                      <Heart size={32} className="text-gray-300" />
                    </div>
                    <p className="text-gray-500 mb-4" style={{ fontSize: '16px' }}>Noch keine Favoriten</p>
                    <button
                      onClick={() => router.push('/')}
                      className="inline-flex items-center gap-2 px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors font-medium text-sm"
                    >
                      Immobilien entdecken
                    </button>
                  </div>
                ) : (
                  <>
                    <div className="flex flex-wrap gap-3">
                      {userFavorites.map((favorite) => {
                        const property = favorite.properties;
                        if (!property) return null;
                        return (
                          <div
                            key={favorite.id}
                            onClick={() => router.push(`/property/${property.id}`)}
                            className="group cursor-pointer bg-white border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-all w-[250px]"
                          >
                            <div className="relative aspect-square bg-gray-100">
                              {property.images && property.images.length > 0 ? (
                                <img
                                  src={property.images[0]}
                                  alt={property.title}
                                  className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                                />
                              ) : (
                                <div className="w-full h-full flex items-center justify-center">
                                  <Home size={24} className="text-gray-300" />
                                </div>
                              )}
                              <FavoriteButton
                                userId={user.id}
                                propertyId={property.id}
                                isFavorite={true}
                                onToggle={(newState) => {
                                  if (!newState) {
                                    setUserFavorites(prev => prev.filter(f => f.property_id !== property.id));
                                  }
                                }}
                                size="sm"
                                variant="story"
                                className="absolute top-1.5 right-1.5"
                              />
                              {property.ai_score && (
                                <div className="absolute bottom-1.5 right-1.5 flex items-center gap-1 bg-black/60 px-2 py-1 rounded-full">
                                  <div
                                    className="w-2 h-2 rounded-full"
                                    style={{ backgroundColor: getScoreColor(property.ai_score) }}
                                  />
                                  <span className="text-white text-xs font-medium">{property.ai_score}/100</span>
                                </div>
                              )}
                            </div>
                            <div className="p-3">
                              <p className="text-primary font-bold text-lg mb-1">{formatPrice(property.price)}</p>
                              <h3 className="font-semibold text-gray-900 text-sm truncate mb-2">{property.title}</h3>
                              <div className="flex items-center gap-1 text-xs text-gray-500 mb-1">
                                <MapPin size={12} className="flex-shrink-0" />
                                <span className="truncate">{property.location}</span>
                              </div>
                              <div className="flex items-center gap-3 text-xs text-gray-600">
                                <span>{property.sqm} m¬≤</span>
                                <span>‚Ä¢</span>
                                <span>{property.rooms} Zi.</span>
                                {property.sqm > 0 && (
                                  <>
                                    <span>‚Ä¢</span>
                                    <span>{formatPrice(Math.round(property.price / property.sqm))}/m¬≤</span>
                                  </>
                                )}
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </>
                )}
              </div>
            </div>
        </div>
      </main>
    );
  }

  // ============================================
  // EDIT VIEW - Chat assistant for profile setup
  // ============================================

  // Live Preview Component
  const LivePreview = () => (
    <div className="bg-white rounded-2xl shadow-lg overflow-hidden h-full flex flex-col border border-gray-200">
      {/* Profile Header with Avatar */}
      <div className="relative bg-gradient-to-br from-primary to-pink-600 h-32">
        <div className="absolute -bottom-12 left-1/2 transform -translate-x-1/2">
          <div className="relative">
            <div className="w-24 h-24 rounded-full bg-white p-1 shadow-lg">
              {profileData.avatar_url || uploadedAvatar ? (
                <img
                  src={uploadedAvatar || profileData.avatar_url}
                  alt="Profilbild"
                  className="w-full h-full rounded-full object-cover"
                />
              ) : (
                <div className="w-full h-full rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center">
                  <span className="text-3xl font-bold text-gray-400">
                    {profileData.first_name?.charAt(0)?.toUpperCase() || user?.email?.charAt(0)?.toUpperCase() || 'U'}
                  </span>
                </div>
              )}
            </div>
            <button className="absolute bottom-0 right-0 w-8 h-8 bg-white rounded-full shadow-md flex items-center justify-center hover:bg-gray-50 transition-colors">
              <Camera size={16} className="text-gray-600" />
            </button>
          </div>
        </div>
      </div>

      {/* Scrollable Content */}
      <div className="overflow-y-auto flex-1 pt-16 px-6 pb-6">
        {/* Name */}
        <div className="text-center mb-6">
          <h1 className="text-xl font-bold text-gray-900">
            {profileData.first_name || profileData.last_name ? (
              `${profileData.first_name || ''} ${profileData.last_name || ''}`.trim()
            ) : (
              <span className="text-gray-300">Ihr Name</span>
            )}
          </h1>
          {profileData.company && (
            <p className="text-gray-500 text-sm mt-1">{profileData.company}</p>
          )}
          {profileData.bio && (
            <p className="text-gray-700 text-sm mt-3 leading-relaxed">{profileData.bio}</p>
          )}
        </div>

        {/* Contact Info */}
        <div className="space-y-3">
          <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
            <Mail size={16} className="text-gray-400" />
            <span className="text-sm text-gray-700">{user?.email}</span>
          </div>

          <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
            <Phone size={16} className="text-gray-400" />
            <span className="text-sm text-gray-700">
              {profileData.phone || <span className="text-gray-300">Telefon</span>}
            </span>
          </div>

          <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
            <MapPin size={16} className="text-gray-400" />
            <span className="text-sm text-gray-700">
              {profileData.address || <span className="text-gray-300">Adresse</span>}
            </span>
          </div>

          <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
            <Building2 size={16} className="text-gray-400" />
            <span className="text-sm text-gray-700">
              {profileData.company || <span className="text-gray-300">Firma</span>}
            </span>
          </div>
        </div>
      </div>

      {/* Bottom Action Bar */}
      <div className="border-t border-gray-200 p-4 bg-white flex-shrink-0 space-y-2">
        {saveSuccess && (
          <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-2 rounded-lg text-sm text-center mb-2">
            Profil erfolgreich gespeichert!
          </div>
        )}

        <button
          onClick={handleSaveProfile}
          disabled={isSubmitting || (!profileData.first_name && !profileData.last_name)}
          className="w-full py-3 bg-primary text-white rounded-lg font-semibold hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {isSubmitting ? 'Speichern...' : 'Profil speichern'}
        </button>
        {isProfileComplete(profile) && (
          <button
            onClick={() => setViewMode('overview')}
            className="w-full py-2 text-gray-600 font-medium hover:bg-gray-50 rounded-lg transition-colors"
          >
            Abbrechen
          </button>
        )}
      </div>
    </div>
  );

  return (
    <main className="min-h-screen bg-gray-50">
      <Header />

      <div className="h-[calc(100vh-100px)] flex flex-col px-4 py-4">
        {/* Progress Bar */}
        <div className="mb-4 max-w-6xl mx-auto w-full">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-medium text-gray-700">Profil-Fortschritt</span>
            <span className="text-sm font-medium text-gray-700">{progress}%</span>
          </div>
          <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
            <div
              className="h-full bg-primary transition-all duration-500"
              style={{ width: `${progress}%` }}
            />
          </div>
        </div>

        {/* Two Column Layout */}
        <div className="flex flex-col lg:flex-row gap-4 lg:gap-6 max-w-6xl mx-auto w-full flex-1 min-h-0 overflow-auto lg:overflow-hidden">
          {/* Chat Column */}
          <div className="flex-1 flex flex-col min-h-[300px] lg:min-h-0">

            {/* Chat Container */}
            <div
              ref={chatContainerRef}
              className="bg-white rounded-2xl shadow-lg overflow-hidden flex-1 min-h-0 border border-gray-200"
            >
              <div className="h-full overflow-y-auto p-6 space-y-5">
                {messages.map((message) => (
                  <div
                    key={message.id}
                    className={`flex gap-3 ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}
                  >
                    {message.type === 'bot' && (
                      <div className="w-10 h-10 bg-gray-900 rounded-full flex items-center justify-center flex-shrink-0">
                        <User className="w-5 h-5 text-white" />
                      </div>
                    )}
                    {message.type === 'bot' ? (
                      <p className="text-[18px] leading-relaxed text-gray-800 pt-2 max-w-[85%]">{message.content}</p>
                    ) : (
                      <div className="bg-gray-100 text-gray-900 rounded-2xl px-5 py-3 max-w-[75%]">
                        <p className="text-[18px] leading-relaxed">{message.content}</p>
                      </div>
                    )}
                  </div>
                ))}

                {/* Typing Indicator */}
                {isTyping && (
                  <div className="flex gap-3 justify-start">
                    <div className="w-10 h-10 bg-gray-900 rounded-full flex items-center justify-center flex-shrink-0">
                      <User className="w-5 h-5 text-white" />
                    </div>
                    <div className="bg-gray-100 rounded-2xl px-5 py-4">
                      <div className="flex space-x-1.5">
                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" />
                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce [animation-delay:0.2s]" />
                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce [animation-delay:0.4s]" />
                      </div>
                    </div>
                  </div>
                )}

                {/* Completion Message */}
                {isComplete && (
                  <div className="flex gap-3 justify-start">
                    <div className="w-10 h-10 bg-gray-900 rounded-full flex items-center justify-center flex-shrink-0">
                      <User className="w-5 h-5 text-white" />
                    </div>
                    <p className="text-[18px] leading-relaxed text-green-700 pt-2 max-w-[85%]">
                      Perfekt! üéâ Ihr Profil ist vollst√§ndig. √úberpr√ºfen Sie die Vorschau rechts und klicken Sie auf &quot;Profil speichern&quot;.
                    </p>
                  </div>
                )}

                {/* Scroll anchor */}
                <div ref={messagesEndRef} />
              </div>
            </div>

            {/* Input Area */}
            <div className="mt-4 flex-shrink-0">
              {!isComplete && !isTyping && currentQuestion && currentQuestion.type === 'bot' && (
                <>
                  {/* Text Input */}
                  {(currentQuestion.inputType === 'text' || currentQuestion.inputType === 'phone') && (
                    <div className="flex gap-2">
                      <input
                        ref={textInputRef}
                        type={currentQuestion.inputType === 'phone' ? 'tel' : 'text'}
                        value={textInput}
                        onChange={(e) => setTextInput(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && handleTextSubmit()}
                        placeholder={currentQuestion.placeholder}
                        className="flex-1 px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors"
                      />
                      <button
                        onClick={() => handleTextSubmit()}
                        disabled={!textInput.trim()}
                        className="px-4 py-3 bg-gray-900 text-white rounded-xl disabled:opacity-50 hover:bg-gray-800 transition-colors"
                      >
                        <Send size={20} />
                      </button>
                    </div>
                  )}

                  {/* Image Upload */}
                  {currentQuestion.inputType === 'image-upload' && (
                    <div className="bg-white rounded-xl p-4 border-2 border-gray-200">
                      <input
                        ref={fileInputRef}
                        type="file"
                        accept="image/jpeg,image/png,image/webp"
                        onChange={handleImageUpload}
                        className="hidden"
                      />

                      <div className="flex flex-col items-center gap-4">
                        <div className="relative">
                          <div className="w-24 h-24 rounded-full bg-gray-100 overflow-hidden border-4 border-gray-200">
                            {uploadedAvatar || profileData.avatar_url ? (
                              <img
                                src={uploadedAvatar || profileData.avatar_url}
                                alt="Profilbild"
                                className="w-full h-full object-cover"
                              />
                            ) : (
                              <div className="w-full h-full flex items-center justify-center">
                                <User size={36} className="text-gray-300" />
                              </div>
                            )}
                          </div>
                        </div>

                        <button
                          onClick={() => fileInputRef.current?.click()}
                          className="flex items-center gap-2 px-4 py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-600 hover:border-primary hover:text-primary transition-colors"
                        >
                          <ImagePlus size={18} />
                          {uploadedAvatar ? 'Anderes Bild w√§hlen' : 'Bild ausw√§hlen'}
                        </button>
                      </div>

                      <button
                        onClick={handleImageSubmit}
                        className="w-full mt-4 py-3 bg-gray-900 text-white rounded-xl font-medium hover:bg-gray-800 transition-colors flex items-center justify-center gap-2"
                      >
                        {uploadedAvatar ? 'Weiter' : '√úberspringen'}
                        <ChevronRight size={18} />
                      </button>
                    </div>
                  )}

                  {/* Textarea Input */}
                  {currentQuestion.inputType === 'textarea' && (
                    <div className="bg-white rounded-xl p-4 border-2 border-gray-200">
                      <textarea
                        ref={textareaRef}
                        value={textInput}
                        onChange={(e) => setTextInput(e.target.value)}
                        placeholder={currentQuestion.placeholder}
                        rows={3}
                        className="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors resize-none text-gray-800"
                      />
                      <div className="flex gap-2 mt-3">
                        <button
                          onClick={() => handleTextSubmit(true)}
                          className="flex-1 py-3 border-2 border-gray-200 text-gray-600 rounded-xl font-medium hover:bg-gray-50 transition-colors"
                        >
                          √úberspringen
                        </button>
                        <button
                          onClick={() => handleTextSubmit()}
                          disabled={!textInput.trim()}
                          className="flex-1 py-3 bg-gray-900 text-white rounded-xl font-medium hover:bg-gray-800 transition-colors flex items-center justify-center gap-2 disabled:opacity-50"
                        >
                          Weiter
                          <ChevronRight size={18} />
                        </button>
                      </div>
                    </div>
                  )}
                </>
              )}
            </div>
          </div>

          {/* Preview Column */}
          <div className="flex-shrink-0 lg:flex-1 lg:min-h-0">
            <LivePreview />
          </div>
        </div>
      </div>
    </main>
  );
}
